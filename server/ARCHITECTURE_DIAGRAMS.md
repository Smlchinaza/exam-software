# Multi-Tenant Architecture Diagrams

## 1. Request Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (React Frontend)                       â”‚
â”‚  - Login/Register                                                   â”‚
â”‚  - View Exams                                                       â”‚
â”‚  - Create/Edit Exams                                                â”‚
â”‚  - Submit/Grade Exams                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â”‚ HTTP Request
                                              â”‚ + JWT Token
                                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXPRESS SERVER (Node.js Backend)                 â”‚
â”‚                                                                      â”‚
â”‚  Route: POST /api/auth/register                                    â”‚
â”‚  Route: POST /api/auth/login                                       â”‚
â”‚  Route: GET  /api/exams              â† Authenticated              â”‚
â”‚  Route: POST /api/exams              â† Authenticated              â”‚
â”‚  Route: POST /api/submissions/*/start â† Authenticated              â”‚
â”‚  Route: POST /api/submissions/*/submit â† Authenticated             â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚        MIDDLEWARE PIPELINE FOR AUTHENTICATED ROUTES â”‚           â”‚
â”‚  â”‚                                                     â”‚           â”‚
â”‚  â”‚  1. authenticateJWT                                â”‚           â”‚
â”‚  â”‚     â”œâ”€ Verify JWT signature                        â”‚           â”‚
â”‚  â”‚     â”œâ”€ Extract payload                             â”‚           â”‚
â”‚  â”‚     â””â”€ Set req.user = {id, email, role, school_id}â”‚           â”‚
â”‚  â”‚                                                     â”‚           â”‚
â”‚  â”‚  2. enforceMultiTenant                             â”‚           â”‚
â”‚  â”‚     â”œâ”€ Extract school_id from req.user.school_id   â”‚           â”‚
â”‚  â”‚     â”œâ”€ Validate school_id exists                   â”‚           â”‚
â”‚  â”‚     â””â”€ Set req.tenant = {schoolId, userId, role}   â”‚           â”‚
â”‚  â”‚                                                     â”‚           â”‚
â”‚  â”‚  3. Route Handler                                  â”‚           â”‚
â”‚  â”‚     â”œâ”€ Access req.tenant.schoolId                  â”‚           â”‚
â”‚  â”‚     â”œâ”€ Build query: WHERE school_id = $1           â”‚           â”‚
â”‚  â”‚     â””â”€ Execute scoped query                        â”‚           â”‚
â”‚  â”‚                                                     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                      â”‚
â”‚  Result: JSON Response                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â”‚ Response
                                              â”‚ (school-scoped data only)
                                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (React Frontend)                       â”‚
â”‚  - Display Exams (only from user's school)                          â”‚
â”‚  - Save JWT in localStorage                                         â”‚
â”‚  - Persist school_id in app context                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Data Isolation Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          POSTGRESQL DATABASE                         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚              SCHOOL 1 (DEFAULT)                         â”‚         â”‚
â”‚  â”‚  school_id: 2c048ff5-bd7f-4c47-89eb-9ca54cc2b360       â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  USERS                                                 â”‚         â”‚
â”‚  â”‚  â”œâ”€ User 1 (Teacher) â†’ school_id = DEFAULT âœ“           â”‚         â”‚
â”‚  â”‚  â”œâ”€ User 2 (Student) â†’ school_id = DEFAULT âœ“           â”‚         â”‚
â”‚  â”‚  â”œâ”€ User 3 (Admin)   â†’ school_id = DEFAULT âœ“           â”‚         â”‚
â”‚  â”‚  â””â”€ (54 total users, all school_id = DEFAULT)         â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  EXAMS                                                 â”‚         â”‚
â”‚  â”‚  â”œâ”€ Math Final Exam â†’ school_id = DEFAULT âœ“            â”‚         â”‚
â”‚  â”‚  â”œâ”€ Science Quiz â†’ school_id = DEFAULT âœ“               â”‚         â”‚
â”‚  â”‚  â”œâ”€ History Test â†’ school_id = DEFAULT âœ“               â”‚         â”‚
â”‚  â”‚  â””â”€ (23 total exams, all school_id = DEFAULT)         â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  EXAM_SUBMISSIONS                                      â”‚         â”‚
â”‚  â”‚  â”œâ”€ Submission 1 â†’ school_id = DEFAULT âœ“               â”‚         â”‚
â”‚  â”‚  â”œâ”€ Submission 2 â†’ school_id = DEFAULT âœ“               â”‚         â”‚
â”‚  â”‚  â””â”€ (17 total submissions, all school_id = DEFAULT)   â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚              SCHOOL 2 (FUTURE - MULTI-TENANT)           â”‚         â”‚
â”‚  â”‚  school_id: (another UUID)                              â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  When added:                                            â”‚         â”‚
â”‚  â”‚  - Users with different school_id                      â”‚         â”‚
â”‚  â”‚  - Exams with different school_id                      â”‚         â”‚
â”‚  â”‚  - Submissions with different school_id                â”‚         â”‚
â”‚  â”‚  - All completely isolated from SCHOOL 1               â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                       â”‚
â”‚  ğŸ”’ ISOLATION ENFORCED AT DATABASE LEVEL:                            â”‚
â”‚  SELECT * FROM exams WHERE school_id = '<user-school-id>'          â”‚
â”‚  â””â”€ Only returns exams from user's school                           â”‚
â”‚                                                                       â”‚
â”‚  ğŸ”’ ISOLATION ENFORCED AT APPLICATION LEVEL:                         â”‚
â”‚  - req.tenant.schoolId extracted from JWT                           â”‚
â”‚  - Every query includes: AND school_id = $1                         â”‚
â”‚  - Impossible to return cross-tenant data                           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Authentication & JWT Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REGISTRATION FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Client: POST /api/auth/register                           â”‚
â”‚ {                                                           â”‚
â”‚   email: "teacher@school.com",                             â”‚
â”‚   password: "secure123",                                   â”‚
â”‚   role: "teacher",                                         â”‚
â”‚   first_name: "John",                                      â”‚
â”‚   last_name: "Doe"                                         â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚  â†“ Server processes:                                       â”‚
â”‚  1. Hash password with bcryptjs                            â”‚
â”‚  2. Create user in DB with DEFAULT school_id             â”‚
â”‚  3. Sign JWT token with payload:                          â”‚
â”‚     {                                                       â”‚
â”‚       id: "user-uuid",                                     â”‚
â”‚       email: "teacher@school.com",                         â”‚
â”‚       role: "teacher",                                     â”‚
â”‚       school_id: "default-school-uuid" â† CRITICAL!        â”‚
â”‚     }                                                       â”‚
â”‚  4. Return token + user data                               â”‚
â”‚                                                             â”‚
â”‚  â† Server Response (201):                                  â”‚
â”‚  {                                                          â”‚
â”‚    token: "eyJhbGciOiJIUzI1NiIs...",                      â”‚
â”‚    user: {                                                  â”‚
â”‚      id: "user-uuid",                                      â”‚
â”‚      email: "teacher@school.com",                          â”‚
â”‚      role: "teacher",                                      â”‚
â”‚      school_id: "default-school-uuid"                      â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LOGIN FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Client: POST /api/auth/login                              â”‚
â”‚ {                                                           â”‚
â”‚   email: "teacher@school.com",                             â”‚
â”‚   password: "secure123"                                    â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚  â†“ Server processes:                                       â”‚
â”‚  1. Find user by email                                     â”‚
â”‚  2. Verify password hash matches                           â”‚
â”‚  3. Sign JWT token with same payload                       â”‚
â”‚  4. Return token + user data                               â”‚
â”‚                                                             â”‚
â”‚  â† Server Response (200):                                  â”‚
â”‚  {                                                          â”‚
â”‚    token: "eyJhbGciOiJIUzI1NiIs...",                      â”‚
â”‚    user: {                                                  â”‚
â”‚      id: "user-uuid",                                      â”‚
â”‚      email: "teacher@school.com",                          â”‚
â”‚      role: "teacher",                                      â”‚
â”‚      school_id: "default-school-uuid"                      â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              JWT TOKEN STRUCTURE (JWT = 3 PARTS)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ HEADER (Part 1)                                            â”‚
â”‚ {                                                           â”‚
â”‚   "alg": "HS256",                                           â”‚
â”‚   "typ": "JWT"                                             â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ PAYLOAD (Part 2) â† Contains school_id!                    â”‚
â”‚ {                                                           â”‚
â”‚   "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",           â”‚
â”‚   "email": "teacher@school.com",                           â”‚
â”‚   "role": "teacher",                                       â”‚
â”‚   "school_id": "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360",    â”‚
â”‚   "iat": 1703001234,                                       â”‚
â”‚   "exp": 1703087634                                        â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ SIGNATURE (Part 3)                                         â”‚
â”‚ HMACSHA256(base64(header) + "." + base64(payload),        â”‚
â”‚            "jwt-secret-key")                               â”‚
â”‚                                                             â”‚
â”‚ Complete Token:                                            â”‚
â”‚ eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.                    â”‚
â”‚ eyJpZCI6ImY0N2FjMTBiLTU4Y2MtNDM3Mi1hNTY3LTBlMDJiMmMzZDQ3OT...  â”‚
â”‚ 7b6f3f8e2c1a9d4b5e6f7a8b9c0d1e2f3a4b5c6d                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Multi-Tenant Middleware Execution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AUTHENTICATED REQUEST PROCESSING FLOW                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚ STEP 1: REQUEST ARRIVES                                             â”‚
â”‚ â”œâ”€ GET /api/exams                                                   â”‚
â”‚ â”œâ”€ Headers: Authorization: Bearer eyJhbGc...                        â”‚
â”‚ â””â”€ req.headers.authorization = "Bearer eyJhbGc..."                  â”‚
â”‚                                                                       â”‚
â”‚  â†“                                                                    â”‚
â”‚                                                                       â”‚
â”‚ STEP 2: authenticateJWT MIDDLEWARE                                  â”‚
â”‚ â”œâ”€ Extract token from "Bearer <token>"                              â”‚
â”‚ â”œâ”€ Verify signature with JWT_SECRET                                 â”‚
â”‚ â”œâ”€ Decode payload                                                   â”‚
â”‚ â”œâ”€ req.user = {                                                     â”‚
â”‚ â”‚   id: "f47ac10b-58cc-4372-a567-0e02b2c3d479",                    â”‚
â”‚ â”‚   email: "teacher@school.com",                                    â”‚
â”‚ â”‚   role: "teacher",                                                â”‚
â”‚ â”‚   school_id: "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360"              â”‚
â”‚ â”‚ }                                                                  â”‚
â”‚ â””â”€ PASS THROUGH âœ“                                                   â”‚
â”‚                                                                       â”‚
â”‚  â†“                                                                    â”‚
â”‚                                                                       â”‚
â”‚ STEP 3: enforceMultiTenant MIDDLEWARE                               â”‚
â”‚ â”œâ”€ Extract school_id from req.user.school_id                        â”‚
â”‚ â”œâ”€ Validate school_id is not null                                   â”‚
â”‚ â”œâ”€ Extract userId from req.user.id                                  â”‚
â”‚ â”œâ”€ Extract role from req.user.role                                  â”‚
â”‚ â”œâ”€ Create tenant object:                                            â”‚
â”‚ â”‚  req.tenant = {                                                   â”‚
â”‚ â”‚    schoolId: "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360",             â”‚
â”‚ â”‚    userId: "f47ac10b-58cc-4372-a567-0e02b2c3d479",               â”‚
â”‚ â”‚    role: "teacher"                                                â”‚
â”‚ â”‚  }                                                                 â”‚
â”‚ â”œâ”€ Log: "Multi-tenant access: school=2c048..., user=f47ac..., role=teacher" â”‚
â”‚ â””â”€ PASS THROUGH âœ“                                                   â”‚
â”‚                                                                       â”‚
â”‚  â†“                                                                    â”‚
â”‚                                                                       â”‚
â”‚ STEP 4: ROUTE HANDLER (GET /api/exams)                             â”‚
â”‚ â”œâ”€ Access req.tenant object                                         â”‚
â”‚ â”œâ”€ Build query:                                                     â”‚
â”‚ â”‚  const { schoolId, userId, role } = req.tenant;                  â”‚
â”‚ â”‚  const result = await pool.query(                                 â”‚
â”‚ â”‚    'SELECT * FROM exams WHERE school_id = $1',                   â”‚
â”‚ â”‚    [schoolId]  â† Automatically scoped to user's school           â”‚
â”‚ â”‚  );                                                               â”‚
â”‚ â”œâ”€ Return result.rows (only exams from schoolId)                   â”‚
â”‚ â””â”€ RESPONSE 200 âœ“                                                   â”‚
â”‚                                                                       â”‚
â”‚  â†“                                                                    â”‚
â”‚                                                                       â”‚
â”‚ STEP 5: RESPONSE SENT                                               â”‚
â”‚ â”œâ”€ HTTP 200 OK                                                      â”‚
â”‚ â”œâ”€ Content-Type: application/json                                   â”‚
â”‚ â”œâ”€ Body: [                                                          â”‚
â”‚ â”‚   {id: "...", school_id: "2c048...", title: "Math Exam", ...},  â”‚
â”‚ â”‚   {id: "...", school_id: "2c048...", title: "Science Quiz", ...} â”‚
â”‚ â”‚ ]                                                                  â”‚
â”‚ â””â”€ All exams have matching school_id âœ“                              â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ERROR HANDLING IN MIDDLEWARE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚ SCENARIO 1: Missing Authorization Header                           â”‚
â”‚ â”œâ”€ Request arrives without: Authorization: Bearer <token>          â”‚
â”‚ â”œâ”€ authenticateJWT catches error                                   â”‚
â”‚ â””â”€ Response 401: { error: "No token provided" }                    â”‚
â”‚                                                                       â”‚
â”‚ SCENARIO 2: Invalid JWT Signature                                  â”‚
â”‚ â”œâ”€ Token provided but signature invalid                            â”‚
â”‚ â”œâ”€ authenticateJWT catches error                                   â”‚
â”‚ â””â”€ Response 401: { error: "Invalid token" }                        â”‚
â”‚                                                                       â”‚
â”‚ SCENARIO 3: Missing school_id in JWT                               â”‚
â”‚ â”œâ”€ Token is valid but payload missing school_id                   â”‚
â”‚ â”œâ”€ enforceMultiTenant catches error                                â”‚
â”‚ â””â”€ Response 403: { error: "No school assigned" }                   â”‚
â”‚                                                                       â”‚
â”‚ SCENARIO 4: Expired JWT                                            â”‚
â”‚ â”œâ”€ Token is old and exp time passed                                â”‚
â”‚ â”œâ”€ authenticateJWT catches error                                   â”‚
â”‚ â””â”€ Response 401: { error: "Token expired" }                        â”‚
â”‚                                                                       â”‚
â”‚ SCENARIO 5: Query returns no results                               â”‚
â”‚ â”œâ”€ Query executes but no matching records                          â”‚
â”‚ â”œâ”€ This is NORMAL (user's school might have no exams)              â”‚
â”‚ â””â”€ Response 200: { data: [] }  (empty array)                       â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SCHOOLS (1 row)                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚ id: UUID (PK)                                         â”‚              â”‚
â”‚ â”‚ name: "Default School"                                â”‚              â”‚
â”‚ â”‚ created_at: timestamp                                 â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â†‘                                                               â”‚
â”‚          â”‚ FK relationships (1 school : many of each)                  â”‚
â”‚          â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚                 â”‚              â”‚                 â”‚                  â”‚
â”‚  â†“                 â†“              â†“                 â†“                  â”‚
â”‚ USERS          EXAMS          SUBJECTS    EXAM_SUBMISSIONS           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ id (PK)  â”‚   â”‚ id (PK)  â”‚  â”‚ id (PK)  â”‚  â”‚ id (PK)          â”‚      â”‚
â”‚ â”‚ school   â”‚   â”‚ school   â”‚  â”‚ school   â”‚  â”‚ school_id (FK)   â”‚      â”‚
â”‚ â”‚ email    â”‚   â”‚ title    â”‚  â”‚ name     â”‚  â”‚ exam_id (FK)     â”‚      â”‚
â”‚ â”‚ role â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  â”‚          â”‚  â”‚ student_id (FK)  â”‚      â”‚
â”‚ â”‚ ...      â”‚   â”‚ ...      â”‚  â”‚ ...      â”‚  â”‚ ...              â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚           â”‚                               â”‚                  â”‚
â”‚         â”‚           â”‚                               â”‚ 1:many          â”‚
â”‚         â”‚           â”‚                               â”‚                  â”‚
â”‚         â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                  â”‚
â”‚         â”‚           â”‚              â†“                â†“                  â”‚
â”‚         â”‚           â”‚          QUESTIONS      EXAM_ANSWERS            â”‚
â”‚         â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚           â”‚          â”‚ id (PK)  â”‚  â”‚ id (PK)      â”‚         â”‚
â”‚         â”‚           â”‚          â”‚ exam_id  â”‚  â”‚ submission   â”‚         â”‚
â”‚         â”‚           â”‚          â”‚ ...      â”‚  â”‚ question_id  â”‚         â”‚
â”‚         â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ answer       â”‚         â”‚
â”‚         â”‚           â”‚              â”‚         â”‚ score        â”‚         â”‚
â”‚         â”‚           â”‚              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚           â”‚              â”‚                                   â”‚
â”‚         â”‚           â”‚              â†“                                   â”‚
â”‚         â”‚           â”‚       QUESTION_OPTIONS                          â”‚
â”‚         â”‚           â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚         â”‚           â”‚       â”‚ id (PK)      â”‚                          â”‚
â”‚         â”‚           â”‚       â”‚ question_id  â”‚                          â”‚
â”‚         â”‚           â”‚       â”‚ text         â”‚                          â”‚
â”‚         â”‚           â”‚       â”‚ is_correct   â”‚                          â”‚
â”‚         â”‚           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚           â”‚                                                  â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â†’ All reference school_id for FK integrity â”‚
â”‚         â”‚                                                              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ User (teacher/admin) references in exams         â”‚
â”‚                                                                       â”‚
â”‚ ğŸ” MULTI-TENANT ENFORCEMENT:                                         â”‚
â”‚ - Every table includes school_id column (except schools)             â”‚
â”‚ - Foreign keys reference both id and school_id (composite FK)        â”‚
â”‚ - Queries always include: WHERE school_id = <user-school-id>       â”‚
â”‚ - Prevents selecting records from different schools                 â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Request Lifecycle Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COMPLETE REQUEST LIFECYCLE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  TIME 0ms: Client sends POST /api/exams with JWT                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  {                                                                        â”‚
â”‚    method: "POST",                                                       â”‚
â”‚    url: "http://localhost:5000/api/exams",                              â”‚
â”‚    headers: {                                                            â”‚
â”‚      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsIn...",               â”‚
â”‚      "Content-Type": "application/json"                                 â”‚
â”‚    },                                                                    â”‚
â”‚    body: {                                                               â”‚
â”‚      "title": "Math Final",                                              â”‚
â”‚      "questions": [{...}]                                               â”‚
â”‚    }                                                                     â”‚
â”‚  }                                                                       â”‚
â”‚                                                                          â”‚
â”‚  TIME 1ms: Express receives request, parses body                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  req.body = { title: "Math Final", questions: [...] }                  â”‚
â”‚                                                                          â”‚
â”‚  TIME 2ms: CORS middleware processes                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Allowed origin? localhost:3000 âœ“                                       â”‚
â”‚                                                                          â”‚
â”‚  TIME 3ms: Route matched: POST /api/exams                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Router: examsPostgres                                                  â”‚
â”‚  Handler: [authenticateJWT, enforceMultiTenant, handler]               â”‚
â”‚                                                                          â”‚
â”‚  TIME 4ms: authenticateJWT middleware executes                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Extract token: "eyJhbGciOiJIUzI1NiIsIn..."                            â”‚
â”‚  Verify signature: âœ“ Valid                                              â”‚
â”‚  Decode payload:                                                        â”‚
â”‚  {                                                                       â”‚
â”‚    id: "f47ac10b-58cc-4372-a567-0e02b2c3d479",                        â”‚
â”‚    email: "teacher@school.com",                                         â”‚
â”‚    role: "teacher",                                                     â”‚
â”‚    school_id: "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360"                  â”‚
â”‚  }                                                                       â”‚
â”‚  req.user = { ... } âœ“                                                   â”‚
â”‚  Next middleware                                                        â”‚
â”‚                                                                          â”‚
â”‚  TIME 5ms: enforceMultiTenant middleware executes                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Extract schoolId from req.user.school_id                               â”‚
â”‚  schoolId = "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360" âœ“                   â”‚
â”‚  Create req.tenant:                                                     â”‚
â”‚  {                                                                       â”‚
â”‚    schoolId: "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360",                   â”‚
â”‚    userId: "f47ac10b-58cc-4372-a567-0e02b2c3d479",                    â”‚
â”‚    role: "teacher"                                                      â”‚
â”‚  }                                                                       â”‚
â”‚  Next handler                                                           â”‚
â”‚                                                                          â”‚
â”‚  TIME 6-50ms: Handler executes                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  1. Validate request (title required, questions array)                 â”‚
â”‚  2. Check authorization (role: teacher)                                â”‚
â”‚  3. Start database transaction                                         â”‚
â”‚  4. Create exam:                                                        â”‚
â”‚     INSERT INTO exams                                                  â”‚
â”‚     (id, school_id, created_by, title, created_at)                    â”‚
â”‚     VALUES ($1, $2, $3, $4, $5)                                        â”‚
â”‚     Parameters: [uuid, "2c048ff5...", user_id, "Math Final", now]     â”‚
â”‚                          â†‘                                              â”‚
â”‚                    FROM req.tenant.schoolId (automatic!)               â”‚
â”‚  5. Create questions with exam_id + school_id                         â”‚
â”‚  6. Create question options with question_id + school_id              â”‚
â”‚  7. Commit transaction                                                 â”‚
â”‚                                                                         â”‚
â”‚  TIME 51ms: Database returns created exam                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Result:                                                                â”‚
â”‚  {                                                                      â”‚
â”‚    id: "new-exam-uuid",                                                â”‚
â”‚    school_id: "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360",                 â”‚
â”‚    created_by: "f47ac10b-58cc-4372-a567-0e02b2c3d479",                â”‚
â”‚    title: "Math Final",                                                â”‚
â”‚    questions: [...]                                                    â”‚
â”‚  }                                                                      â”‚
â”‚                                                                         â”‚
â”‚  TIME 52ms: Handler sends response                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  res.status(201).json(result)                                          â”‚
â”‚  Response headers:                                                      â”‚
â”‚    HTTP/1.1 201 Created                                                â”‚
â”‚    Content-Type: application/json                                      â”‚
â”‚    Access-Control-Allow-Origin: http://localhost:3000                 â”‚
â”‚  Response body:                                                         â”‚
â”‚  {                                                                      â”‚
â”‚    "id": "new-exam-uuid",                                              â”‚
â”‚    "school_id": "2c048ff5-bd7f-4c47-89eb-9ca54cc2b360",               â”‚
â”‚    "created_by": "f47ac10b-58cc-4372-a567-0e02b2c3d479",              â”‚
â”‚    "title": "Math Final",                                              â”‚
â”‚    "questions": [...]                                                  â”‚
â”‚  }                                                                      â”‚
â”‚                                                                         â”‚
â”‚  TIME 55ms: Client receives response                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Frontend stores exam data                                             â”‚
â”‚  Navigates to exam editor                                              â”‚
â”‚                                                                         â”‚
â”‚  âœ“ REQUEST COMPLETE (55ms total)                                       â”‚
â”‚  âœ“ SCHOOL SCOPING ENFORCED (automatic via req.tenant)                 â”‚
â”‚  âœ“ NO CROSS-TENANT DATA POSSIBLE                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Multi-Tenant Enforcement Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHERE MULTI-TENANCY IS ENFORCED                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚ ğŸ” LAYER 1: APPLICATION LOGIC                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ enforceMultiTenant middleware                                   â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ if (!schoolId) {                                               â”‚    â”‚
â”‚ â”‚   return res.status(403)                                       â”‚    â”‚
â”‚ â”‚     .json({ error: "No school/tenant assigned" });             â”‚    â”‚
â”‚ â”‚ }                                                               â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ req.tenant = {                                                 â”‚    â”‚
â”‚ â”‚   schoolId,        â† Extracted from JWT                       â”‚    â”‚
â”‚ â”‚   userId,                                                      â”‚    â”‚
â”‚ â”‚   role                                                          â”‚    â”‚
â”‚ â”‚ };                                                              â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” LAYER 2: QUERY CONSTRUCTION                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Every route handler uses req.tenant.schoolId in WHERE clause   â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ const { schoolId, userId, role } = req.tenant;                â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ const result = await pool.query(                               â”‚    â”‚
â”‚ â”‚   'SELECT * FROM exams WHERE school_id = $1',                 â”‚    â”‚
â”‚ â”‚   [schoolId]  â† Query parameter substitution (SQL injection safe) â”‚
â”‚ â”‚ );                                                              â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ âœ“ Automatic school scoping                                     â”‚    â”‚
â”‚ â”‚ âœ“ No hardcoded school IDs                                      â”‚    â”‚
â”‚ â”‚ âœ“ Impossible to bypass (parameterized queries)                 â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” LAYER 3: DATABASE SCHEMA                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Every table has school_id column (REQUIRED NOT NULL)           â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ CREATE TABLE exams (                                           â”‚    â”‚
â”‚ â”‚   id UUID PRIMARY KEY,                                         â”‚    â”‚
â”‚ â”‚   school_id UUID NOT NULL,    â† Mandatory                     â”‚    â”‚
â”‚ â”‚   created_by UUID NOT NULL,   â† Teacher who created           â”‚    â”‚
â”‚ â”‚   title VARCHAR NOT NULL,                                      â”‚    â”‚
â”‚ â”‚   ...                                                           â”‚    â”‚
â”‚ â”‚   CONSTRAINT fk_school FOREIGN KEY (school_id)                â”‚    â”‚
â”‚ â”‚     REFERENCES schools(id) ON DELETE CASCADE                   â”‚    â”‚
â”‚ â”‚ );                                                              â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ CREATE INDEX idx_exams_school_id ON exams(school_id);         â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ âœ“ School_id required (can't create exam without school)       â”‚    â”‚
â”‚ â”‚ âœ“ Indexed for fast lookups                                     â”‚    â”‚
â”‚ â”‚ âœ“ Foreign key prevents orphaned records                        â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” LAYER 4: DATA INTEGRITY                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Composite Foreign Keys ensure referential integrity            â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ CREATE TABLE exam_submissions (                                â”‚    â”‚
â”‚ â”‚   id UUID PRIMARY KEY,                                         â”‚    â”‚
â”‚ â”‚   school_id UUID NOT NULL,                                     â”‚    â”‚
â”‚ â”‚   exam_id UUID NOT NULL,                                       â”‚    â”‚
â”‚ â”‚   student_id UUID NOT NULL,                                    â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚   CONSTRAINT fk_exam FOREIGN KEY (exam_id, school_id)         â”‚    â”‚
â”‚ â”‚     REFERENCES exams(id, school_id)                           â”‚    â”‚
â”‚ â”‚       ON DELETE CASCADE,                                        â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚   CONSTRAINT fk_student FOREIGN KEY (student_id, school_id)   â”‚    â”‚
â”‚ â”‚     REFERENCES users(id, school_id)                           â”‚    â”‚
â”‚ â”‚       ON DELETE CASCADE                                         â”‚    â”‚
â”‚ â”‚ );                                                              â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ âœ“ Can't reference exam from different school                  â”‚    â”‚
â”‚ â”‚ âœ“ Can't reference student from different school               â”‚    â”‚
â”‚ â”‚ âœ“ School_id must match across all related tables              â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” LAYER 5: AUTHORIZATION CHECKS                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Role-based checks within route handlers                        â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ // Only teachers/admins can create exams                       â”‚    â”‚
â”‚ â”‚ if (!['teacher', 'admin'].includes(role)) {                    â”‚    â”‚
â”‚ â”‚   return res.status(403).json({ error: 'Not authorized' });   â”‚    â”‚
â”‚ â”‚ }                                                               â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ // Teachers can only edit their own exams                      â”‚    â”‚
â”‚ â”‚ if (exam.created_by !== userId && role !== 'admin') {         â”‚    â”‚
â”‚ â”‚   return res.status(403).json({ error: 'Not authorized' });   â”‚    â”‚
â”‚ â”‚ }                                                               â”‚    â”‚
â”‚ â”‚                                                                 â”‚    â”‚
â”‚ â”‚ âœ“ Role validation                                              â”‚    â”‚
â”‚ â”‚ âœ“ Ownership verification                                       â”‚    â”‚
â”‚ â”‚ âœ“ Admin override capability                                    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” DEFENSE IN DEPTH APPROACH                                            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   If Layer 1 fails (malicious middleware manipulation)            â”‚    â”‚
â”‚   â†’ Layer 2 prevents query (no school_id parameter)               â”‚    â”‚
â”‚   â†’ Layer 3 requires school_id in DB (insert fails)               â”‚    â”‚
â”‚   â†’ Layer 4 validates foreign keys (constraint fails)             â”‚    â”‚
â”‚   â†’ Layer 5 is final authorization check                          â”‚    â”‚
â”‚                                                                          â”‚
â”‚   Result: Impossible to access cross-tenant data!                      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This comprehensive diagram set explains the complete multi-tenant architecture from request entry through database storage and back to the client.
